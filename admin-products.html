<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - Rosemilk Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#fff0f3', 100: '#ffe3e8', 200: '#ffc9d6', 300: '#ff9fb6',
                            400: '#ff6b8e', 500: '#f73b68', 600: '#e31b4b', 700: '#bf0e36',
                            800: '#9e0d2d', 900: '#850f29',
                        },
                    },
                    fontFamily: {
                        serif: ['Playfair Display', 'serif'],
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>

<body class="font-sans antialiased text-gray-800 bg-gray-50 flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col">
        <div class="h-20 flex items-center justify-center border-b border-gray-100">
            <a href="index.html" class="flex items-center gap-2">
                <i class="fa-solid fa-rose text-brand-500 text-2xl"></i>
                <span class="font-serif text-2xl font-bold text-gray-900">Rosemilk</span>
            </a>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            <a href="admin-dashboard.html"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-brand-600 rounded-lg font-medium transition">
                <i class="fa-solid fa-chart-pie w-5"></i> Dashboard
            </a>
            <a href="admin-products.html"
                class="flex items-center gap-3 px-4 py-3 bg-brand-50 text-brand-600 rounded-lg font-medium">
                <i class="fa-solid fa-box w-5"></i> Products
            </a>
            <a href="admin-orders.html"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-brand-600 rounded-lg font-medium transition">
                <i class="fa-solid fa-shopping-bag w-5"></i> Orders
            </a>
            <a href="admin-customers.html"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-brand-600 rounded-lg font-medium transition">
                <i class="fa-solid fa-users w-5"></i> Customers
            </a>
            <a href="admin-settings.html"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 hover:text-brand-600 rounded-lg font-medium transition">
                <i class="fa-solid fa-gear w-5"></i> Settings
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100">
            <a href="#" onclick="logout()"
                class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:text-red-600 transition">
                <i class="fa-solid fa-arrow-right-from-bracket w-5"></i> Logout
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Header -->
        <header class="h-20 bg-white border-b border-gray-200 flex items-center justify-between px-8">
            <h2 class="text-xl font-bold text-gray-800">Product Management</h2>
            <div class="flex items-center gap-3">
                <button onclick="openModal()"
                    class="bg-brand-500 hover:bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Add Product
                </button>
            </div>
        </header>

        <!-- Products List -->
        <div class="flex-1 overflow-auto p-8">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-gray-600">
                        <thead class="bg-gray-50 text-xs uppercase font-medium text-gray-500">
                            <tr>
                                <th class="px-6 py-4">Product</th>
                                <th class="px-6 py-4">Category</th>
                                <th class="px-6 py-4">Price</th>
                                <th class="px-6 py-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body" class="divide-y divide-gray-100 text-sm">
                            <!-- Products will be loaded here -->
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center text-gray-400">Loading products...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Product Modal -->
    <div id="productModal"
        class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-800">Manage Product</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i
                        class="fa-solid fa-times text-xl"></i></button>
            </div>

            <form id="productForm" class="p-6 space-y-4">
                <input type="hidden" id="editId">

                <!-- Image Upload Section -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Product Image</label>
                    <div class="flex items-start gap-4">
                        <div id="previewBox"
                            class="hidden w-24 h-24 rounded-lg border border-gray-200 overflow-hidden bg-gray-50 flex-shrink-0">
                            <img id="imgPreview" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <input type="file" id="pImageFile" accept="image/*"
                                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-50 file:text-brand-600 hover:file:bg-brand-100 mb-2">
                            <p class="text-xs text-gray-400">Or use URL (optional):</p>
                            <input type="url" id="pImageUrl" placeholder="https://..."
                                class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="pName" required
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500">
                    </div>
                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="pCategory"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500">
                            <option>Face Care</option>
                            <option>Body Care</option>
                            <option>Lip Care</option>
                            <option>Hair Care</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-gray-700">Price ($)</label>
                        <input type="number" step="0.01" id="pPrice" required
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500">
                    </div>
                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-gray-700">Stock</label>
                        <input type="number" id="pStock" required
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500">
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="block text-sm font-medium text-gray-700">Suitable Skin Types</label>
                    <div class="flex flex-wrap gap-4 p-3 border border-gray-200 rounded-lg bg-gray-50">
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <input type="checkbox" name="skin_type" value="Oily" class="rounded text-brand-500"> Oily
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <input type="checkbox" name="skin_type" value="Dry" class="rounded text-brand-500"> Dry
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <input type="checkbox" name="skin_type" value="Sensitive" class="rounded text-brand-500">
                            Sensitive
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <input type="checkbox" name="skin_type" value="All" class="rounded text-brand-500"> All
                            Types
                        </label>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" id="saveBtn"
                        class="w-full bg-brand-500 hover:bg-brand-600 text-white font-bold py-3 rounded-lg transition shadow-md hover:shadow-lg">
                        Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://dyptudqbdygqkjnqizxt.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_1ybwmjWUlErvgvRAuNVVNw_duKOSDtl';

        // Initialize Supabase Client
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const tableBody = document.getElementById('products-table-body');
        const modal = document.getElementById('productModal');
        const productForm = document.getElementById('productForm');

        // 1. Load Data from Supabase
        async function loadProducts() {
            tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">Loading components...</td></tr>';

            const { data, error } = await _supabase
                .from('products')
                .select('*')
                .order('id', { ascending: false });

            if (error) {
                console.error('Error fetching:', error);
                tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-red-500">Error loading products: ${error.message}</td></tr>`;
                return;
            }
            renderTable(data);
        }

        // 2. Render Table
        function renderTable(products) {
            if (!tableBody) return;

            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">No products found. Add one to get started!</td></tr>';
                return;
            }

            tableBody.innerHTML = products.map(p => `
                <tr class="hover:bg-gray-50 border-b transition group">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-lg border border-gray-100 overflow-hidden bg-white shrink-0">
                                <img src="${p.image_url || 'https://via.placeholder.com/150?text=No+Image'}" 
                                     class="w-full h-full object-cover" 
                                     onerror="this.src='https://via.placeholder.com/150?text=Error'">
                            </div>
                            <div>
                                <p class="font-medium text-gray-900 line-clamp-1">${p.name}</p>
                                <p class="text-xs text-gray-400">ID: ${p.id}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">${p.category}</span></td>
                    <td class="px-6 py-4 font-bold text-gray-900">$${parseFloat(p.price).toFixed(2)}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick='editProduct(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="text-gray-400 hover:text-blue-500 mx-1 transition p-2 rounded-full hover:bg-blue-50"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteProduct(${p.id})" class="text-gray-400 hover:text-red-500 mx-1 transition p-2 rounded-full hover:bg-red-50"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        // 3. Form Submission (Upload + Save)
        if (productForm) {
            productForm.onsubmit = async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('saveBtn');
                const originalBtnText = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

                try {
                    const id = document.getElementById('editId').value;
                    const fileInput = document.getElementById('pImageFile');
                    const urlInput = document.getElementById('pImageUrl') ? document.getElementById('pImageUrl').value : '';
                    let finalImageUrl = urlInput; // Default to URL input if no file

                    // Image Upload Logic
                    if (fileInput && fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        // Sanitize filename and add timestamp
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;

                        const { data: uploadData, error: uploadError } = await _supabase.storage
                            .from('product-images')
                            .upload(fileName, file);

                        if (uploadError) {
                            if (uploadError.message.includes('row-level security')) {
                                alert("⚠️ Supabase Security Error!\n\nYou must run the SQL script in your Supabase Dashboard to enable uploads.\n\nPlease check the 'supabase_fix.sql' file I created for you.");
                                console.error("RUN THIS SQL IN SUPABASE:\n\n" +
                                    "create policy \"Public Access\" on storage.objects for all to anon using ( bucket_id = 'product-images' );\n" +
                                    "create policy \"Public Insert\" on products for all to anon using ( true ) with check ( true );");
                            }
                            throw new Error("Upload failed: " + uploadError.message);
                        }

                        const { data: publicUrlData } = _supabase.storage
                            .from('product-images')
                            .getPublicUrl(fileName);

                        finalImageUrl = publicUrlData.publicUrl;
                    }

                    const skinTypes = Array.from(document.querySelectorAll('input[name="skin_type"]:checked')).map(cb => cb.value);

                    const productData = {
                        name: document.getElementById('pName').value,
                        category: document.getElementById('pCategory').value,
                        price: parseFloat(document.getElementById('pPrice').value),
                        stock: parseInt(document.getElementById('pStock').value),
                        skin_type: skinTypes.join(', '), // Save as comma-separated string
                        image_url: finalImageUrl
                    };

                    let response;
                    if (id) {
                        response = await _supabase.from('products').update(productData).eq('id', id);
                    } else {
                        response = await _supabase.from('products').insert([productData]);
                    }

                    if (response.error) {
                        if (response.error.message.includes('row-level security')) {
                            alert("⚠️ Supabase Security Error!\n\nYou must run the SQL script in Supabase to allow saving products.\n\nCheck the console for the SQL command.");
                        }
                        throw new Error(response.error.message);
                    }

                    closeModal();
                    loadProducts();
                    alert("Product saved successfully!");

                } catch (err) {
                    alert(err.message);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'Save Product';
                }
            };
        }

        // Preview Logic
        document.getElementById('pImageFile').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imgPreview').src = e.target.result;
                    document.getElementById('previewBox').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        // Actions
        async function deleteProduct(id) {
            if (confirm("Are you sure you want to delete this product?")) {
                const { error } = await _supabase.from('products').delete().eq('id', id);
                if (error) alert("Error deleting: " + error.message);
                else loadProducts();
            }
        }

        function openModal() {
            productForm.reset();
            document.getElementById('editId').value = "";
            document.getElementById('previewBox').classList.add('hidden');
            document.getElementById('imgPreview').src = "";
            document.getElementById('saveBtn').innerHTML = 'Save Product';
            modal.classList.replace('hidden', 'flex');
        }

        function closeModal() { modal.classList.replace('flex', 'hidden'); }

        function editProduct(p) {
            openModal();
            document.getElementById('editId').value = p.id;
            document.getElementById('pName').value = p.name;
            document.getElementById('pCategory').value = p.category;
            document.getElementById('pPrice').value = p.price;
            document.getElementById('pStock').value = p.stock || 0;

            if (p.skin_type) {
                const types = p.skin_type.split(', ');
                document.querySelectorAll('input[name="skin_type"]').forEach(cb => {
                    cb.checked = types.includes(cb.value);
                });
            }

            if (p.image_url) {
                document.getElementById('imgPreview').src = p.image_url;
                document.getElementById('pImageUrl').value = p.image_url;
                document.getElementById('previewBox').classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }

        // Initial Load
        document.addEventListener('DOMContentLoaded', loadProducts);
    </script>
</body>

</html>